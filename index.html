<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Darkroom Process Timer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Darkroom Timer" />
<meta name="theme-color" content="#0a0a0a" />
<meta name="format-detection" content="telephone=no,email=no,address=no" />

<style>
  /* Design tokens (default dark) */
  :root{
    --bg: #0a0a0a;
    --panel: #0f0f0f;
    --muted: #999;
    --accent: #9d84b7;
    --accent-strong: #7c5aa8;
    --success: #4ade80;
    --warning: #fbbf24;
    --danger: #ff6b6b;
    --border: #2b2b2b;
    --text: #d0d0d0;
    --input-bg: #121212;
    --radius: 10px;
    --gap: 10px;
    --touch: 44px;
    --ui: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    --max-width: 960px;
  }

  body.theme-light{
    --bg: #f6f7fb;
    --panel: #ffffff;
    --muted: #6b7280;
    --accent: #6a5aa8;
    --accent-strong: #4f3f86;
    --border: #e6e6e9;
    --text: #0b0b0b;
    --input-bg: #fbfbfd;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html,body { height:100%; margin:0; font-family:var(--ui); background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  body { display:flex; justify-content:center; padding:10px; }

  /* App container */
  .app {
    width: clamp(320px, 92vw, 420px);
    max-width: var(--max-width);
    margin: 0 auto;
    background: transparent;
  }

  @media (min-width:1200px){
    .app { transform: scale(1.02); transform-origin: top center; }
  }

  .panel { background:var(--panel); border-radius:var(--radius); padding:12px; border:1px solid var(--border); box-shadow: 0 8px 20px rgba(0,0,0,0.16); }
  h1 { text-align:center; margin:6px 0 10px 0; font-size:18px; }
  label {
    display:block;
    font-size:11px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:0.4px;
    margin-bottom:6px;
  }

  input, select, textarea, button {
    font-size:14px;
    padding:9px 10px;
    color:var(--text);
    background:var(--input-bg);
    border:1px solid var(--border);
    border-radius:8px;
    outline:none;
  }
  textarea { min-height:120px; resize:vertical; width:100%; }
  input::placeholder, textarea::placeholder { color:#8c8c8c; }

  /* Tabs row */
  .tabs { display:flex; gap:8px; margin-bottom:10px; }
  .tab-btn { flex:1 1 0; padding:8px 10px; border-radius:8px; background:transparent; color:var(--text); border:1px solid var(--border); font-weight:600; }
  .tab-btn.active { background:var(--accent); color:#000; border-color:var(--accent); }

  /* Steps row: visually calmer, tip column constrained */
  #steps { display:flex; flex-direction:column; gap:6px; margin-top:6px; }
  .step {
    display:grid;
    gap:6px;
    grid-template-columns: 1fr 60px 52px minmax(80px,120px) 28px;
    align-items:center;
    padding:6px 4px;
    background: transparent;
    border-radius:8px;
  }

  .step input { padding:6px 8px; font-size:13px; line-height:1.1; background:var(--input-bg); border:1px solid rgba(255,255,255,0.03); width:100%; box-sizing:border-box; }
  .step .min, .step .sec { text-align:center; }
  .step .tip { font-size:13px; color:var(--muted); max-width:120px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .step .remove { width:24px; height:24px; border-radius:6px; display:inline-flex; align-items:center; justify-content:center; font-size:12px; padding:0; opacity:0.7; transition:opacity .12s ease; background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--text); }
  .step .remove:hover { opacity:1; }

  @media (max-width:360px){
    .step { grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; }
    .step .name { grid-column: 1 / -1; }
    .step .min { grid-column: 1 / 2; }
    .step .sec { grid-column: 2 / 3; }
    .step .tip { grid-column: 1 / -1; max-width:100%; white-space:normal; }
    .step .remove { grid-column: 2 / 3; justify-self:end; }
  }

  .row { display:flex; gap:8px; align-items:flex-start; flex-wrap:wrap; }
  .col { flex:1 1 auto; min-width:0; }
  .col-fixed { flex:0 0 auto; width:92px; max-width:30%; }
  .col-fixed input, .col-fixed select { width:100%; box-sizing:border-box; }

  .timer { text-align:center; font-weight:700; font-variant-numeric:tabular-nums; font-size:38px; margin:8px 0; letter-spacing:-0.5px; }
  @media (min-width:420px) { .timer { font-size:44px; } }
  .timer.running { color:var(--success); }
  .timer.paused { color:var(--warning); }
  .timer.done { color:var(--danger); }

  #progress { height:10px; background:#131313; border-radius:8px; overflow:hidden; border:1px solid var(--border); }
  #bar { height:100%; width:0%; background:var(--accent); transition: width .08s linear; }

  .current { text-align:center; padding:6px; border-radius:8px; border:1px solid rgba(157,132,183,0.06); margin-bottom:8px; font-size:13px; }
  .muted { color:var(--muted); font-size:13px; }

  .controls-row { display:flex; gap:8px; margin-top:10px; }
  .control-btn { flex:1 1 0; min-height:40px; border-radius:10px; font-weight:700; background:var(--accent); color:#000; display:inline-flex; align-items:center; justify-content:center; padding:8px 10px; font-size:14px; }
  .control-btn.secondary { background:transparent; border:1px solid var(--border); color:var(--text); }

  .action-row { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px; }
  .action-row .save-full { grid-column: 1 / -1; }

  .theme-toggle { position:fixed; right:10px; top:10px; width:36px; height:36px; border-radius:8px; border:1px solid var(--border); background:transparent; color:var(--text); display:inline-flex; align-items:center; justify-content:center; font-size:16px; z-index:1000; }

  @media (max-width: 480px) {
    .controls-row {
      gap: 8px;
    }

    .control-btn {
      min-height: 48px;
      font-size: 14px;
    }
  }

  /* page visibility */
  .page { display: none; }
  .page.active { display: block; }

</style>
</head>
<body>
  <div class="app">
    <button id="themeToggle" class="theme-toggle" title="Toggle light/dark" onclick="toggleTheme()">ðŸŒ™</button>

    <h1>Darkroom Process Timer</h1>

    <div class="tabs">
      <button id="tabEditor" class="tab-btn active" onclick="switchTo('editor')">Editor</button>
      <button id="tabTimer" class="tab-btn" onclick="switchTo('timer')">Timer</button>
    </div>

    <!-- Editor page: all inputs, steps, saved processes, and file actions -->
    <div id="editorPage" class="page active">
      <div class="panel" id="editorPanel">
        <label>Process type</label>
        <select id="processType" onchange="updateProcessNames()">
          <option>Film</option>
          <option>Printing</option>
          <option>Alternative Printing</option>
        </select>

        <label style="margin-top:8px">Process name</label>
        <select id="processName"></select>

        <div class="row" style="margin-top:8px;">
          <div class="col">
            <label>Film / Paper</label>
            <input id="filmName" placeholder="e.g. Kodak Portra 400" />
          </div>
          <div class="col-fixed">
            <label>Temp (Â°C)</label>
            <input id="temperature" type="number" placeholder="20" />
          </div>
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="col">
            <label>Developer</label>
            <input id="developerName" placeholder="e.g. D-76" />
          </div>
          <div class="col-fixed">
            <label>Push / Pull</label>
            <select id="pushPull">
              <option>Pull -2</option>
              <option>Pull -1</option>
              <option selected>Normal</option>
              <option>Push +1</option>
              <option>Push +2</option>
              <option>Push +3</option>
            </select>
          </div>
        </div>

        <label style="margin-top:8px">Variation / Notes</label>
        <textarea id="notes" placeholder="Add variations or notes"></textarea>

        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0;">

        <label>Steps</label>
        <div id="steps" aria-live="polite"></div>
        <div style="margin-top:8px;display:flex;gap:8px;">
          <button class="control-btn secondary" style="flex:0 0 auto;padding:8px 12px" onclick="addStep()">+ Add Step</button>
          <div style="flex:1"></div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0;">

        <div class="muted" id="totalTime">Total: 00:00</div>

        <div class="action-row" role="group" aria-label="File actions">
          <button class="control-btn save-full" onclick="saveProcess()">Save Process</button>
          <button class="control-btn secondary" onclick="importProcess()">Import JSON</button>
          <button class="control-btn secondary" onclick="exportProcess()">Export JSON</button>
          <button class="control-btn secondary" onclick="printCard()">Print</button>
          <!-- New Reset button (resets entered inputs only) -->
          <button class="control-btn secondary" onclick="resetInputs()">Reset Inputs</button>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0;">

        <label>Saved processes</label>
        <select id="savedProcesses" onchange="loadProcess()"></select>

        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="control-btn secondary" style="flex:1" onclick="deleteProcess()">Delete</button>
          <button class="control-btn secondary" style="flex:1" onclick="exportCSV()">Export CSV</button>
        </div>

      </div>
    </div>

    <!-- Timer page: timer display + current step + controls -->
    <div id="timerPage" class="page">
      <div class="panel" id="timerPanel">
        <div class="current" id="currentStep">Ready</div>
        <div style="text-align:center;font-size:12px;color:var(--muted);margin-bottom:6px;">
          <span id="stepCounter">-</span>
        </div>

        <div class="timer" id="timer">00:00</div>
        <div id="progress"><div id="bar"></div></div>

        <div class="controls-row">
          <button id="startBtn" class="control-btn" onclick="start()">Start</button>
          <button id="pauseBtn" class="control-btn" onclick="pause()">Pause</button>
          <button id="stopBtn" class="control-btn" onclick="stopTimer()">Stop</button>
          <button id="audioToggle" class="control-btn" onclick="toggleAudio()" title="Toggle sound">ðŸ”Š</button>
        </div>

        <div style="margin-top:10px;color:var(--muted);font-size:13px;text-align:center;">
          Timer page â€” use these controls while running your process. Switch to Editor to modify steps.
        </div>
      </div>
    </div>

  </div>

  <input type="file" id="fileInput" hidden />

<script>
  // Page switching
  function switchTo(page) {
    document.getElementById('editorPage').classList.remove('active');
    document.getElementById('timerPage').classList.remove('active');
    document.getElementById('tabEditor').classList.remove('active');
    document.getElementById('tabTimer').classList.remove('active');

    if (page === 'editor') {
      document.getElementById('editorPage').classList.add('active');
      document.getElementById('tabEditor').classList.add('active');
    } else {
      document.getElementById('timerPage').classList.add('active');
      document.getElementById('tabTimer').classList.add('active');
      renderTimerUI();
    }
  }

  function renderTimerUI() {
    const step = steps[timerIndex] || null;
    document.getElementById('currentStep').innerText = step ? step.name : (isRunning ? 'Running' : 'Ready');
    document.getElementById('stepCounter').innerText = isRunning ? `${Math.min(steps.length, timerIndex + 1)}/${steps.length}` : '-';
    document.getElementById('timer').innerText = formatTime(Math.max(0, Math.ceil(remainingSeconds)));
    if (!isRunning && timerIndex === 0) document.getElementById('bar').style.width = '0%';
  }

  // DOM refs (shared between pages)
  const timerEl = document.getElementById("timer");
  const currentStepEl = document.getElementById("currentStep");
  const startBtn = document.getElementById("startBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const stopBtn = document.getElementById("stopBtn");
  const bar = document.getElementById("bar");
  const processType = document.getElementById("processType");
  const processName = document.getElementById("processName");
  const filmName = document.getElementById("filmName");
  const developerName = document.getElementById("developerName");
  const temperature = document.getElementById("temperature");
  const pushPull = document.getElementById("pushPull");
  const notes = document.getElementById("notes");
  const savedProcesses = document.getElementById("savedProcesses");
  const fileInput = document.getElementById("fileInput");
  const totalTimeEl = document.getElementById("totalTime");
  const stepCounter = document.getElementById("stepCounter");
  const themeToggle = document.getElementById("themeToggle");

  // State (unchanged)
  let currentProcessName = null;
  let steps = [];
  let timerIndex = 0;
  let remainingSeconds = 0;
  let timerInterval = null;
  let pauseInterval = null;
  let audioEnabled = localStorage.getItem("darkroomAudio") !== "false";
  let isRunning = false;
  let isPaused = false;
  let pausedSeconds = 0;
  let pauseStartTime = null;
  let wakelock = null;
  let history = JSON.parse(localStorage.getItem("darkroomHistory")) || [];
  let processes = JSON.parse(localStorage.getItem("darkroomProcesses")) || {};

  const processOptions = {
    "Film": ["C-41", "ECN-2", "E-6", "B&W", "B&W Reversal"],
    "Printing": ["B&W Contact Printing", "RA-4 Contact Printing", "B&W Reversal Printing", "RA-4 Reversal Printing"],
    "Alternative Printing": ["Cyanotype", "Salt Printing", "Carbon Transfer", "Vandyke Brown", "Albumen", "Gum Bichromate", "Platinum/Palladium", "Bromoil"]
  };

  // Theme handling
  function applySavedTheme(){
    const t = localStorage.getItem('darkroomTheme') || 'dark';
    document.body.classList.toggle('theme-light', t === 'light');
    themeToggle.textContent = t === 'light' ? 'â˜€ï¸' : 'ðŸŒ™';
  }
  function toggleTheme(){
    const isLight = document.body.classList.toggle('theme-light');
    localStorage.setItem('darkroomTheme', isLight ? 'light' : 'dark');
    themeToggle.textContent = isLight ? 'â˜€ï¸' : 'ðŸŒ™';
  }

  // Play a short click/beep immediately (used for toggle feedback even when audioEnabled is false)
  function playClick() {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'sine';
      osc.frequency.value = 880; // beep pitch
      gain.gain.setValueAtTime(0.0001, ctx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.25, ctx.currentTime + 0.005);
      gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.18);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(ctx.currentTime);
      osc.stop(ctx.currentTime + 0.18);
      setTimeout(() => { try { ctx.close && ctx.close(); } catch (e) {} }, 300);
    } catch (e) {
      console.warn('playClick failed', e);
    }
  }

  // Play the regular alarm sound â€” respects audioEnabled unless force parameter passed
  function playSound(force = false) {
    if (!force && !audioEnabled) return;
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.frequency.value = 880;
      osc.type = "sine";
      gain.gain.setValueAtTime(0.3, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
      osc.start(audioContext.currentTime);
      osc.stop(audioContext.currentTime + 0.3);
      setTimeout(() => { try { audioContext.close && audioContext.close(); } catch (e) {} }, 400);
    } catch (e) {
      console.log("Audio failed:", e);
    }
  }

  function toggleAudio() {
    // always play immediate click
    playClick();

    // flip the stored preference
    audioEnabled = !audioEnabled;
    localStorage.setItem("darkroomAudio", audioEnabled ? "true" : "false");
    document.getElementById("audioToggle").style.opacity = audioEnabled ? "1" : "0.5";

    // play a short confirmation tone, force it so user hears the change right away
    playSound(true);
  }

  // Initialization & core functions
  function init(){
    applySavedTheme();
    addStep("Developer",8,0,"Agitate every 30 sec");
    addStep("Stop",0,30,"");
    addStep("Fix",5,0,"");
    addStep("Wash",10,0,"Multiple rinses");
    refreshProcessList();
    updateProcessNames();
    renderSteps();
    updateTotalTime();
    pauseInterval = setInterval(updatePauseTime,200);
    updateUIState();
    document.getElementById("audioToggle").style.opacity = audioEnabled ? "1" : "0.5";
  }

  function formatTime(seconds){
    const total = Math.max(0, Math.floor(seconds));
    const m = Math.floor(total/60);
    const s = total % 60;
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  function updateUIState(){
    startBtn.disabled = isRunning;
    pauseBtn.disabled = !isRunning;
    pauseBtn.textContent = isPaused ? "â–¶ Resume" : "â¸ Pause";
    stopBtn.disabled = !isRunning && !isPaused;
  }

  function addStep(name="",min=0,sec=0,tip=""){
    steps.push({name,min,sec,tip});
    renderSteps();
    updateTotalTime();
  }

  function removeStep(i){
    if(isRunning) return;
    steps.splice(i,1);
    renderSteps();
    updateTotalTime();
  }

  function renderSteps(){
    const box = document.getElementById("steps");
    box.innerHTML = "";
    steps.forEach((s,i) => {
      const row = document.createElement("div");
      row.className = "step";

      const name = document.createElement("input");
      name.className = "name";
      name.type = "text";
      name.placeholder = "Step name";
      name.value = s.name;
      name.disabled = isRunning;
      name.oninput = e => { steps[i].name = e.target.value; };

      const min = document.createElement("input");
      min.className = "min";
      min.type = "number";
      min.min = 0;
      min.value = s.min;
      min.disabled = isRunning;
      min.oninput = e => { steps[i].min = Math.max(0, Number(e.target.value)||0); updateTotalTime(); };

      const sec = document.createElement("input");
      sec.className = "sec";
      sec.type = "number";
      sec.min = 0; sec.max = 59;
      sec.value = s.sec;
      sec.disabled = isRunning;
      sec.oninput = e => { steps[i].sec = Math.max(0, Math.min(59, Number(e.target.value)||0)); updateTotalTime(); };

      const tip = document.createElement("input");
      tip.className = "tip";
      tip.type = "text";
      tip.placeholder = "Tip (optional)";
      tip.value = s.tip;
      tip.disabled = isRunning;
      tip.oninput = e => { steps[i].tip = e.target.value; };

      const remove = document.createElement("button");
      remove.className = "remove btn secondary";
      remove.title = "Remove step";
      remove.innerText = "âœ•";
      remove.onclick = () => { removeStep(i); };

      row.appendChild(name);
      row.appendChild(min);
      row.appendChild(sec);
      row.appendChild(tip);
      row.appendChild(remove);

      box.appendChild(row);
    });
  }

  function updateTotalTime(){
    const total = steps.reduce((sum,s) => sum + ((s.min||0)*60 + (s.sec||0)), 0);
    totalTimeEl.innerText = `Total: ${formatTime(total)}`;
  }

  function updateUpcomingSteps(){ /* minimal on mobile */ }

  async function start(){
    if(!steps.length){ alert("Add at least one step first"); return; }
    isRunning = true; isPaused = false; timerIndex = 0; pausedSeconds = 0;
    updateUIState();
    try { if("wakeLock" in navigator) wakelock = await navigator.wakeLock.request("screen"); } catch(e){ wakelock = null; }
    nextStep();
    // switch automatically to timer page when starting
    switchTo('timer');
  }

  function nextStep(){
    if(timerInterval) clearInterval(timerInterval);
    if(timerIndex >= steps.length){ endTimer(); return; }
    const s = steps[timerIndex];
    remainingSeconds = (s.min||0)*60 + (s.sec||0);
    currentStepEl.innerText = s.name || "Step";
    stepCounter.innerText = `${timerIndex+1}/${steps.length}`;
    bar.style.width = "0%";
    tick();
    timerInterval = setInterval(tick,100);
  }

  function tick(){
    const displaySeconds = Math.ceil(Math.max(0, remainingSeconds));
    timerEl.innerText = formatTime(displaySeconds);
    const step = steps[timerIndex] || {min:0,sec:0};
    const totalSeconds = (step.min||0)*60 + (step.sec||0) || 1;
    const elapsed = totalSeconds - remainingSeconds;
    const progress = (elapsed/totalSeconds)*100;
    bar.style.width = `${Math.max(0, Math.min(100, progress))}%`;
    if(displaySeconds <= 10 && displaySeconds > 0) timerEl.style.transform = `scale(${1 + (displaySeconds%2) * 0.03})`;
    else timerEl.style.transform = "scale(1)";
    remainingSeconds -= 0.1;
    if(remainingSeconds <= 0){
      remainingSeconds = 0;
      clearInterval(timerInterval);
      playSound();
      vibrate();
      timerIndex++;
      setTimeout(()=> nextStep(), 500);
    }
  }

  function pause(){
    if(!isRunning) return;
    if(!isPaused){ clearInterval(timerInterval); isPaused = true; pauseStartTime = Date.now(); }
    else { if(pauseStartTime) pausedSeconds += Math.floor((Date.now() - pauseStartTime)/1000); isPaused = false; timerInterval = setInterval(tick,100); }
    updateUIState();
  }

  function stopTimer(){
    if(timerInterval) clearInterval(timerInterval);
    isRunning = false; isPaused = false;
    timerEl.innerText = "00:00"; currentStepEl.innerText = "Ready"; stepCounter.innerText = '-'; pausedSeconds = 0; bar.style.width='0%';
    if(wakelock){ wakelock.release().catch(()=>{}); wakelock=null; }
    updateUIState();
  }

  function endTimer(){
    clearInterval(timerInterval);
    isRunning = false;
    timerEl.className = 'timer done';
    currentStepEl.innerText = 'âœ… Complete!';
    timerEl.innerText = '00:00';
    bar.style.width = '100%';
    stepCounter.innerText = 'Done';
    updateUIState();
    addToHistory(currentProcessName || 'Quick Process');
  }

  function vibrate(){ if(navigator.vibrate) navigator.vibrate([50,30,50]); }

  // Persistence & export (unchanged)
  function updateProcessNames(selected=null){
    const type = processType.value;
    const list = processOptions[type] || [];
    processName.innerHTML = '';
    list.forEach(n => { const o = document.createElement('option'); o.value = o.textContent = n; processName.appendChild(o); });
    if(selected) processName.value = selected;
  }

  function saveProcess(){
    let key = currentProcessName;
    if(!key){ key = prompt("Name this process (unique key):"); if(!key) return; }
    processes[key] = {
      processType: processType.value,
      processName: processName.value || key,
      filmName: filmName.value,
      developerName: developerName.value,
      temperature: temperature.value,
      pushPull: pushPull.value,
      notes: notes.value,
      steps: JSON.parse(JSON.stringify(steps))
    };
    localStorage.setItem('darkroomProcesses', JSON.stringify(processes));
    currentProcessName = key;
    refreshProcessList();
    addToHistory(key);
    alert('Saved: ' + key);
  }

  function refreshProcessList(){
    savedProcesses.innerHTML = '<option value="">Load saved process</option>';
    Object.keys(processes).sort().forEach(k => {
      const o = document.createElement('option');
      o.value = o.textContent = k;
      savedProcesses.appendChild(o);
    });
  }

  function loadProcess(){
    const key = savedProcesses.value;
    if(!key) return;
    currentProcessName = key;
    const p = processes[key] || {};
    processType.value = p.processType || 'Film';
    updateProcessNames(p.processName);
    filmName.value = p.filmName || '';
    developerName.value = p.developerName || '';
    temperature.value = p.temperature || '';
    pushPull.value = p.pushPull || 'Normal';
    notes.value = p.notes || '';
    steps = JSON.parse(JSON.stringify(p.steps || []));
    renderSteps(); updateTotalTime();
  }

  function deleteProcess(){
    const key = savedProcesses.value;
    if(!key){ alert('Select a process'); return; }
    if(!confirm(`Delete "${key}"?`)) return;
    delete processes[key];
    localStorage.setItem('darkroomProcesses', JSON.stringify(processes));
    refreshProcessList();
    currentProcessName = null;
    alert('Deleted');
  }

  function exportProcess(){ const data = JSON.stringify(processes, null, 2); const blob = new Blob([data], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `darkroom-processes-${new Date().toISOString().split('T')[0]}.json`; a.click(); }
  function importProcess(){ fileInput.click(); }
  fileInput.onchange = e => { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = () => { try { const imported = JSON.parse(r.result); processes = {...processes, ...imported}; localStorage.setItem('darkroomProcesses', JSON.stringify(processes)); refreshProcessList(); alert('Imported'); } catch(err){ alert('Invalid JSON file'); } }; r.readAsText(f); };

  function exportCSV(){ const entries = Object.entries(processes); if(!entries.length){ alert('No saved processes to export.'); return; } const header = ['Saved Key','Process Name','Type','Film/Paper','Developer','Temperature (Â°C)','Push/Pull','Total Time','Notes','Steps']; const rows=[header]; entries.forEach(([key,p])=>{ const proc = p||{}; const stepsArr = proc.steps || []; const total = stepsArr.reduce((s,st)=>s + ((st.min||0)*60 + (st.sec||0)),0); const stepsText = stepsArr.map((st,idx)=>{ const dur = formatTime((st.min||0)*60 + (st.sec||0)); const tip = st.tip ? ` - ${st.tip}` : ''; return `${idx+1}. ${st.name || ''} (${dur})${tip}`; }).join(' | '); const row=[key,proc.processName||key,proc.processType||'',proc.filmName||'',proc.developerName||'',proc.temperature||'',proc.pushPull||'',formatTime(total),(proc.notes||'').replace(/\r?\n/g,' | '),stepsText]; rows.push(row); }); const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n'); const bom = '\uFEFF'; const blob = new Blob([bom + csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `darkroom-saved-processes-${new Date().toISOString().split('T')[0]}.csv`; a.click(); }

  function printCard(){ if(!steps.length){ alert('Add steps first'); return; } let html = '<!doctype html><html><head><meta charset="utf-8"><title>Darkroom Card</title><style>body{font-family:monospace;padding:20px}h1{font-size:18px}.step{margin:8px 0}</style></head><body>'; html += `<h1>${processName.value || currentProcessName || 'Process'}</h1>`; html += `<div><strong>Film/Paper:</strong> ${filmName.value || '-'}<br><strong>Developer:</strong> ${developerName.value || '-'}<br><strong>Temp:</strong> ${temperature.value || '-'}Â°C</div>`; html += '<h3>Steps</h3>'; steps.forEach((s,i)=>{ html += `<div class="step"><strong>${i+1}. ${s.name || ''}</strong> â€” ${formatTime((s.min||0)*60 + (s.sec||0))}${s.tip ? `<div>${s.tip}</div>` : ''}</div>`; }); html += '</body></html>'; const w = window.open(); w.document.write(html); w.document.close(); setTimeout(()=>w.print(),200); }

  function addToHistory(name){ const now = new Date(); history.unshift(`${now.toLocaleDateString()} ${now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${name}`); if(history.length>200) history.length=200; localStorage.setItem('darkroomHistory', JSON.stringify(history)); }

  // NEW: resetInputs - clears entered input only (does NOT touch saved processes, theme, audio, history)
  function resetInputs() {
    if (!confirm("Reset all entered inputs? This will clear current form fields and steps but will NOT delete saved processes.")) return;

    currentProcessName = null;

    // reset selects/fields to defaults
    processType.value = "Film";
    updateProcessNames();
    processName.selectedIndex = 0;

    filmName.value = "";
    developerName.value = "";
    temperature.value = "";
    pushPull.value = "Normal";
    notes.value = "";

    // reset steps to default starter steps
    steps = [];
    addStep("Developer", 8, 0, "Agitate every 30 sec");
    addStep("Stop", 0, 30, "");
    addStep("Fix", 5, 0, "");
    addStep("Wash", 10, 0, "Multiple rinses");

    renderSteps();
    updateTotalTime();

    // ensure timer UI reflects reset state
    timerIndex = 0;
    remainingSeconds = 0;
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    // update timer page visuals if visible
    renderTimerUI();

    alert("Inputs have been reset.");
  }

  function updatePauseTime(){ /* placeholder kept for compatibility (no UI) */ }

  document.addEventListener('keydown', e => { if(e.code === 'Space'){ e.preventDefault(); if(!isRunning) start(); else pause(); } if(e.code === 'Escape') stopTimer(); });
  document.addEventListener('touchmove', e => { if(isRunning) e.preventDefault(); }, {passive:false});

  // initialize
  (function(){ applySavedTheme(); init(); })();
</script>
</body>
</html>
