<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Darkroom Process Timer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Darkroom Timer">
<meta name="theme-color" content="#0a0a0a">
<!-- Removed PDF library (html2pdf) per request - PDF saving option removed -->
<style>
* {
  -webkit-tap-highlight-color: transparent;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  margin: 0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, monospace;
  background: #0a0a0a;
  color: #d0d0d0;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.app {
  max-width: 900px;
  margin: 20px auto;
  padding: 12px;
}

/* layout */
.app-grid {
  display: block;
  gap: 18px;
}
@media (min-width: 820px) {
  .app-grid {
    display: grid;
    grid-template-columns: 1fr 340px;
    align-items: start;
    gap: 20px;
  }
}

/* headings & basic form */
h1 {
  text-align: center;
  font-size: 20px;
  margin: 6px 0 14px 0;
}

label { display:block; font-size:12px; margin-bottom:4px; }

input, select, textarea, button {
  width: 100%;
  margin-bottom: 8px;
  padding: 8px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #444;
  background: #121212;
  color: #d0d0d0;
  outline: none;
}

textarea { resize: vertical; min-height: 64px; }

/* buttons */
button {
  min-height: 40px;
  font-size: 14px;
  background: #9d84b7;
  color: #000;
  cursor: pointer;
  transition: transform 0.12s ease, opacity 0.12s ease;
  border: none;
  border-radius: 6px;
}
button:active { transform: translateY(1px); }
button:disabled { opacity: 0.5; cursor: not-allowed; }

.secondary {
  background: #2b2b2b;
  color: #d0c5e6;
  border: 1px solid #3d3d3d;
}

/* controls layout (Start bigger) */
.controls-row {
  display: flex;
  gap: 8px;
  align-items: center;
}

.controls-row .start-btn { flex: 2 1 0; min-width: 120px; }
.controls-row button:not(.start-btn), .controls-row .audio-toggle { flex: 1 1 0; }

/* action-row (Save / Import / Export / Print) - side-by-side layout */
.action-row {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.action-row button {
  flex: 1 1 48%;
  min-width: 120px;
}

/* step list */
.step {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
  align-items: center;
}

/* step inputs: name should have more space; min/sec fixed small width; tip flexible */
.step-inputs {
  display: flex;
  gap: 8px;
  flex: 1;
  align-items: center;
}
.step-inputs input[type="text"] { flex: 2 1 0; min-width: 140px; }
.step-inputs input.step-tip { flex: 1 1 0; }

.step-inputs input[type="number"] { width: 64px; padding: 8px; }

/* small remove button so the name doesn't get pushed out */
.step-delete {
  width: 36px;
  min-width: 36px;
  min-height: 36px;
  padding: 6px;
  border-radius: 6px;
  font-size: 14px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/* timer & visual */
.timer {
  text-align: center;
  font-size: 44px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  margin: 12px 0;
  transition: color 0.2s, transform 0.12s;
  letter-spacing: -2px;
}
@media (min-width: 820px) { .timer { font-size: 56px; } }
.timer.running { color: #4ade80; }
.timer.paused { color: #fbbf24; }
.timer.done { color: #ff6b6b; }

.current {
  text-align: center;
  font-size: 13px;
  padding: 8px;
  border: 2px solid #9d84b7;
  border-radius: 8px;
  margin-bottom: 8px;
}

.info-box {
  background: #0f0f0f;
  border: 1px solid #2f2a3f;
  padding: 8px;
  border-radius: 8px;
  margin-bottom: 8px;
  font-size: 13px;
  text-align: center;
  color: #d0d0d0;
}

.upcoming {
  background: #0f0f0f;
  border-left: 3px solid #9d84b7;
  padding: 8px;
  margin-bottom: 8px;
  font-size: 13px;
  max-height: 140px;
  overflow-y: auto;
  border-radius: 6px;
}
.upcoming-item { padding: 6px 0; color: #aaa; }
.upcoming-item.next { color: #4ade80; font-weight: 700; }
.step-tip { font-size: 11px; color: #9aa; margin-top: 6px; }

/* progress */
#progress { height: 14px; background: #1a1a1a; border-radius: 6px; overflow: hidden; border: 1px solid #2b2b2b; }
#bar { height: 100%; width: 0%; background: #9d84b7; transition: width 0.08s linear; }

/* responsiveness */
@media (max-width: 420px) {
  body { padding: 6px; }
  .app { margin: 6px; padding: 6px; }
  input, select, textarea, button { font-size: 14px; padding: 8px; }
  .timer { font-size: 48px; }
}

/* focus */
button:focus, input:focus, select:focus, textarea:focus {
  box-shadow: 0 0 0 3px rgba(157,132,183,0.16);
  border-color: #a98ac3;
}
</style>
</head>

<body>
<div class="app">
  <h1>Darkroom Process Timer</h1>

  <div class="app-grid">
    <div class="main">
      <label>Process type</label>
      <select id="processType" onchange="updateProcessNames()">
        <option>Film</option>
        <option>Printing</option>
        <option>Alternative Printing</option>
      </select>

      <label>Process name</label>
      <select id="processName"></select>

      <label>Film / Paper</label>
      <input id="filmName" placeholder="e.g. Kodak Portra 400">

      <label>Developer</label>
      <input id="developerName" placeholder="e.g. D-76">

      <label>Temperature(Â°C)</label>
      <input id="temperature" type="number" placeholder="20">

      <label>Push / Pull</label>
      <select id="pushPull">
        <option>Pull -2</option>
        <option>Pull -1</option>
        <option selected>Normal</option>
        <option>Push +1</option>
        <option>Push +2</option>
        <option>Push +3</option>
      </select>

      <label>Variation / Notes</label>
      <textarea id="notes"></textarea>

      <hr>

      <div id="steps"></div>
      <button class="secondary" onclick="addStep()">+ Add Step</button>

      <hr>

      <div class="info-box" id="totalTime"></div>
      <div class="upcoming" id="upcomingSteps"></div>
      <div class="info-box" id="pauseTime" style="display:none;"></div>

      <div class="current" id="currentStep">Ready</div>
      <div style="text-align:center;font-size:12px;color:#999;margin-bottom:6px;">
        <span class="step-counter" id="stepCounter"></span>
      </div>

      <div class="timer" id="timer">00:00</div>
      <div id="progress">
        <div id="bar"></div>
      </div>

      <div class="controls-row" style="margin-top:10px;">
        <button id="startBtn" class="start-btn" onclick="start()">Start</button>
        <button id="pauseBtn" class="secondary" onclick="pause()">Pause</button>
        <button id="stopBtn" class="secondary" onclick="stopTimer()">Stop</button>
        <button class="audio-toggle secondary" id="audioToggle" onclick="toggleAudio()" title="Toggle sound">ðŸ”Š</button>
      </div>

      <hr>

      <div class="action-row" style="margin-bottom:8px;">
        <button onclick="saveProcess()">Save Process</button>
        <button class="secondary" onclick="importProcess()">Import JSON</button>
        <button class="secondary" onclick="exportProcess()">Export JSON</button>
        <button class="secondary" onclick="printCard()">Print</button>
      </div>

    </div>

    <aside class="sidebar">
      <label>Saved processes</label>
      <select id="savedProcesses" onchange="loadProcess()"></select>

      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="secondary" onclick="deleteProcess()">Delete</button>
        <button class="secondary" onclick="exportCSV()">ðŸ“Š CSV</button>
      </div>

      <hr>
      <!-- history section removed per request -->
    </aside>
  </div>

  <input type="file" id="fileInput" hidden>
</div>

<script>
// ===== DOM Elements =====
const timer = document.getElementById("timer");
const currentStep = document.getElementById("currentStep");
const startBtn = document.getElementById("startBtn");
const pauseBtn = document.getElementById("pauseBtn");
const stopBtn = document.getElementById("stopBtn");
const bar = document.getElementById("bar");
const processType = document.getElementById("processType");
const processName = document.getElementById("processName");
const filmName = document.getElementById("filmName");
const developerName = document.getElementById("developerName");
const temperature = document.getElementById("temperature");
const pushPull = document.getElementById("pushPull");
const notes = document.getElementById("notes");
const savedProcesses = document.getElementById("savedProcesses");
const fileInput = document.getElementById("fileInput");

// ===== State Management =====
let currentProcessName = null; // key used in saved processes
let steps = [];
let timerIndex = 0;
let remainingSeconds = 0;
let timerInterval = null;
let pauseInterval = null;
let audioEnabled = localStorage.getItem("darkroomAudio") !== "false";
let isRunning = false;
let isPaused = false;
let pausedSeconds = 0;
let pauseStartTime = null;
let wakelock = null;
// history stored but UI removed
let history = JSON.parse(localStorage.getItem("darkroomHistory")) || [];
let processes = JSON.parse(localStorage.getItem("darkroomProcesses")) || {};

// ===== Process Options =====
const processOptions = {
  "Film": ["C-41", "ECN-2", "E-6", "B&W", "B&W Reversal"],
  "Printing": ["B&W Contact Printing", "RA-4 Contact Printing", "B&W Reversal Printing", "RA-4 Reversal Printing"],
  "Alternative Printing": ["Cyanotype", "Salt Printing", "Carbon Transfer", "Vandyke Brown", "Albumen", "Gum Bichromate", "Platinum/Palladium", "Bromoil"]
};

// ===== Initialization =====
function init() {
  addStep("Developer", 8, 0, "Agitate every 30 sec");
  addStep("Stop", 0, 30, "");
  addStep("Fix", 5, 0, "");
  addStep("Wash", 10, 0, "Multiple rinses");
  refreshProcessList();
  updateProcessNames();
  renderSteps();
  updateTotalTime();
  pauseInterval = setInterval(updatePauseTime, 200);
  updateUIState();
  document.getElementById("audioToggle").style.opacity = audioEnabled ? "1" : "0.5";
}

// ===== Helpers =====
function formatTime(seconds) {
  const total = Math.max(0, Math.floor(seconds));
  const m = Math.floor(total / 60);
  const s = total % 60;
  return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
}

function updateUIState() {
  const timerRunning = isRunning;
  startBtn.disabled = timerRunning;
  pauseBtn.disabled = !timerRunning;
  pauseBtn.textContent = isPaused ? "â–¶ Resume" : "â¸ Pause";
  stopBtn.disabled = !timerRunning && !isPaused;
}

// ===== Steps =====
function addStep(name = "", min = 0, sec = 0, tip = "") {
  steps.push({ name, min, sec, tip });
  renderSteps();
  updateTotalTime();
}

function removeStep(i) {
  steps.splice(i, 1);
  renderSteps();
  updateTotalTime();
}

function renderSteps() {
  const box = document.getElementById("steps");
  box.innerHTML = "";

  steps.forEach((s, i) => {
    const div = document.createElement("div");
    div.className = "step";

    const inputsDiv = document.createElement("div");
    inputsDiv.className = "step-inputs";

    const nameInput = document.createElement("input");
    nameInput.type = "text";
    nameInput.placeholder = "Step name";
    nameInput.value = s.name;
    nameInput.disabled = isRunning;
    nameInput.oninput = e => { steps[i].name = e.target.value; updateUpcomingSteps(); };

    const minInput = document.createElement("input");
    minInput.type = "number";
    minInput.placeholder = "M";
    minInput.value = s.min;
    minInput.disabled = isRunning;
    minInput.min = "0";
    minInput.className = "step-min";
    minInput.oninput = e => { steps[i].min = Math.max(0, Number(e.target.value)); updateTotalTime(); };

    const secInput = document.createElement("input");
    secInput.type = "number";
    secInput.placeholder = "S";
    secInput.value = s.sec;
    secInput.disabled = isRunning;
    secInput.min = "0";
    secInput.max = "59";
    secInput.className = "step-sec";
    secInput.oninput = e => { steps[i].sec = Math.max(0, Math.min(59, Number(e.target.value))); updateTotalTime(); };

    const tipInput = document.createElement("input");
    tipInput.type = "text";
    tipInput.placeholder = "Tip (e.g. Agitate every 30 sec)";
    tipInput.value = s.tip || "";
    tipInput.disabled = isRunning;
    tipInput.className = "step-tip";
    tipInput.oninput = e => { steps[i].tip = e.target.value; };

    inputsDiv.appendChild(nameInput);
    inputsDiv.appendChild(minInput);
    inputsDiv.appendChild(secInput);
    inputsDiv.appendChild(tipInput);

    const btn = document.createElement("button");
    btn.className = "step-delete secondary";
    btn.title = "Remove step";
    btn.innerText = "âœ•";
    btn.disabled = isRunning;
    btn.onclick = () => removeStep(i);

    div.appendChild(inputsDiv);
    div.appendChild(btn);
    box.appendChild(div);
  });
}

// ===== Totals & Upcoming =====
function updateTotalTime() {
  let totalSec = 0;
  steps.forEach(s => { totalSec += (s.min||0) * 60 + (s.sec||0); });
  document.getElementById("totalTime").innerText = `Total: ${formatTime(totalSec)}`;
}

function updateUpcomingSteps() {
  const upcoming = document.getElementById("upcomingSteps");
  upcoming.innerHTML = "";

  if (timerIndex < steps.length && isRunning) {
    const current = steps[timerIndex];
    const tip = current.tip || "";
    const currentTime = formatTime((current.min||0) * 60 + (current.sec||0));
    upcoming.innerHTML = `<div class="upcoming-item next">â–¶ ${current.name} (${currentTime})${tip ? "<br><small class='step-tip'>" + tip + "</small>" : ""}</div>`;

    for (let i = timerIndex + 1; i < Math.min(timerIndex + 4, steps.length); i++) {
      const s = steps[i];
      const stepTime = formatTime((s.min||0) * 60 + (s.sec||0));
      upcoming.innerHTML += `<div class="upcoming-item">${s.name} (${stepTime})</div>`;
    }
  } else if (!isRunning) {
    for (let i = 0; i < Math.min(3, steps.length); i++) {
      const s = steps[i];
      const stepTime = formatTime((s.min||0) * 60 + (s.sec||0));
      upcoming.innerHTML += `<div class="upcoming-item">${s.name} (${stepTime})</div>`;
    }
  }
}

function getStepColor(name) {
  const lower = (name || "").toLowerCase();
  if (lower.includes("develop")) return "color-dev";
  if (lower.includes("stop")) return "color-stop";
  if (lower.includes("fix")) return "color-fix";
  if (lower.includes("wash")) return "color-wash";
  return "";
}

// ===== Timer control =====
async function start() {
  if (!steps.length) { alert("Add at least one step first"); return; }
  isRunning = true; isPaused = false; timerIndex = 0; pausedSeconds = 0;
  updateUIState(); updateUpcomingSteps();

  try { if ("wakeLock" in navigator) wakelock = await navigator.wakeLock.request("screen"); }
  catch (err) { console.log("Wake lock failed:", err); wakelock = null; }

  nextStep();
}

function nextStep() {
  if (timerInterval) clearInterval(timerInterval);
  if (timerIndex >= steps.length) { endTimer(); return; }

  const s = steps[timerIndex];
  remainingSeconds = (s.min||0) * 60 + (s.sec||0);

  currentStep.innerText = s.name || "Step";
  currentStep.className = "current " + getStepColor(s.name || "");
  document.getElementById("stepCounter").innerText = `${timerIndex + 1}/${steps.length}`;

  if (s.tip) {
    const tipEl = document.createElement("div");
    tipEl.className = "step-tip";
    tipEl.innerText = s.tip;
    const existing = currentStep.querySelector(".step-tip");
    if (existing) existing.remove();
    currentStep.appendChild(tipEl);
  } else {
    const existing = currentStep.querySelector(".step-tip");
    if (existing) existing.remove();
  }

  bar.style.width = "0%";
  tick();
  timerInterval = setInterval(tick, 100);
  updateUpcomingSteps();
}

function tick() {
  const displaySeconds = Math.ceil(Math.max(0, remainingSeconds));
  timer.innerText = formatTime(displaySeconds);

  const step = steps[timerIndex] || { min: 0, sec: 0 };
  const totalSeconds = (step.min || 0) * 60 + (step.sec || 0) || 1;
  const elapsed = totalSeconds - remainingSeconds;
  const progress = (elapsed / totalSeconds) * 100;
  bar.style.width = Math.max(0, Math.min(100, progress)) + "%";

  if (displaySeconds <= 10 && displaySeconds > 0) timer.style.transform = `scale(${1 + (displaySeconds % 2) * 0.04})`;
  else timer.style.transform = "scale(1)";

  remainingSeconds -= 0.1;

  if (remainingSeconds <= 0) {
    remainingSeconds = 0;
    clearInterval(timerInterval);
    playSound();
    vibrate();
    timerIndex++;
    setTimeout(() => nextStep(), 450);
  }
}

function pause() {
  if (!isRunning) return;
  if (!isPaused) {
    clearInterval(timerInterval);
    isPaused = true;
    pauseStartTime = Date.now();
    timer.className = "timer paused";
    document.getElementById("pauseTime").style.display = "block";
    document.getElementById("pauseTime").style.opacity = "1";
  } else {
    if (pauseStartTime) pausedSeconds += Math.floor((Date.now() - pauseStartTime) / 1000);
    document.getElementById("pauseTime").style.display = "none";
    isPaused = false;
    timer.className = "timer running";
    timerInterval = setInterval(tick, 100);
  }
  updateUIState();
}

function stopTimer() {
  if (!isRunning && !isPaused) return;
  if (timerInterval) clearInterval(timerInterval);
  isRunning = false; isPaused = false;
  timer.className = "timer";
  timer.innerText = "00:00"; timer.style.transform = "scale(1)";
  currentStep.innerText = "Ready"; currentStep.className = "current";
  document.getElementById("stepCounter").innerText = "-";
  document.getElementById("upcomingSteps").innerHTML = "";
  document.getElementById("pauseTime").style.display = "none";
  pausedSeconds = 0; bar.style.width = "0%";
  if (wakelock) { wakelock.release().catch(e => console.warn("WakeLock release failed", e)); wakelock = null; }
  updateUIState();
}

function endTimer() {
  clearInterval(timerInterval);
  isRunning = false;
  timer.className = "timer done";
  currentStep.innerText = "âœ… Complete!";
  currentStep.style.borderColor = "#4ade80";
  timer.innerText = "00:00";
  bar.style.width = "100%";
  document.getElementById("stepCounter").innerText = "Done";
  document.getElementById("upcomingSteps").innerHTML = "";
  addToHistory(currentProcessName || "Quick Process");
  playSound(); vibrate();
  if (wakelock) { wakelock.release().catch(e => console.warn("WakeLock release failed", e)); wakelock = null; }
  setTimeout(() => { startBtn.disabled = false; pauseBtn.disabled = true; }, 1000);
  updateUIState();
}

function updatePauseTime() {
  if (isPaused && pauseStartTime) {
    const elapsed = pausedSeconds + Math.floor((Date.now() - pauseStartTime) / 1000);
    document.getElementById("pauseTime").innerText = `â¸ Paused: ${formatTime(elapsed)}`;
  }
}

// ===== Audio =====
function vibrate() { if (navigator.vibrate) navigator.vibrate([50,30,50]); }

function playSound() {
  if (!audioEnabled) return;
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const osc = audioContext.createOscillator();
    const gain = audioContext.createGain();
    osc.connect(gain);
    gain.connect(audioContext.destination);
    osc.frequency.value = 880; osc.type = "sine";
    gain.gain.setValueAtTime(0.3, audioContext.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
    osc.start(audioContext.currentTime);
    osc.stop(audioContext.currentTime + 0.3);
  } catch (e) { console.log("Audio failed:", e); }
}

function toggleAudio() {
  audioEnabled = !audioEnabled;
  localStorage.setItem("darkroomAudio", audioEnabled ? "true" : "false");
  document.getElementById("audioToggle").style.opacity = audioEnabled ? "1" : "0.5";
  if (audioEnabled) playSound();
}

// ===== Process management =====
function updateProcessNames(selected = null) {
  const type = processType.value;
  const list = processOptions[type] || [];
  processName.innerHTML = "";
  list.forEach(name => {
    const o = document.createElement("option");
    o.value = o.textContent = name;
    processName.appendChild(o);
  });
  if (selected) processName.value = selected;
}

function saveProcess() {
  let name = currentProcessName;
  if (!name) { name = prompt("Name this process (this will be the saved key)"); if (!name) return; }

  processes[name] = {
    processType: processType.value,
    processName: processName.value || name, // ensure processName exists
    filmName: filmName.value,
    developerName: developerName.value,
    temperature: temperature.value,
    pushPull: pushPull.value,
    notes: notes.value,
    steps: JSON.parse(JSON.stringify(steps))
  };

  localStorage.setItem("darkroomProcesses", JSON.stringify(processes));
  currentProcessName = name;
  refreshProcessList();
  addToHistory(name);
  alert(`Saved: ${name}`);
}

function refreshProcessList() {
  const sel = document.getElementById("savedProcesses");
  sel.innerHTML = "<option value=''>Load saved process</option>";
  Object.keys(processes).sort().forEach(p => {
    const o = document.createElement("option");
    o.value = o.textContent = p;
    sel.appendChild(o);
  });
}

function loadProcess() {
  const name = savedProcesses.value;
  if (!name) return;
  currentProcessName = name;
  const p = processes[name] || {};
  processType.value = p.processType || "Film";
  updateProcessNames(p.processName);
  filmName.value = p.filmName || "";
  developerName.value = p.developerName || "";
  temperature.value = p.temperature || "";
  pushPull.value = p.pushPull || "Normal";
  notes.value = p.notes || "";
  steps = JSON.parse(JSON.stringify(p.steps || []));
  renderSteps();
  updateTotalTime();
}

function deleteProcess() {
  const name = savedProcesses.value;
  if (!name) { alert("Select a process to delete"); return; }
  if (!confirm(`Delete "${name}"?`)) return;
  delete processes[name];
  localStorage.setItem("darkroomProcesses", JSON.stringify(processes));
  savedProcesses.value = "";
  currentProcessName = null;
  refreshProcessList();
  alert("Deleted!");
}

// ===== Import/Export =====
function exportProcess() {
  const data = JSON.stringify(processes, null, 2);
  const blob = new Blob([data], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `darkroom-processes-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
}
function importProcess() { fileInput.click(); }
fileInput.onchange = e => {
  const file = e.target.files[0];
  const r = new FileReader();
  r.onload = () => {
    try {
      const imported = JSON.parse(r.result);
      processes = { ...processes, ...imported };
      localStorage.setItem("darkroomProcesses", JSON.stringify(processes));
      refreshProcessList();
      alert("Imported successfully!");
    } catch {
      alert("Invalid JSON file");
    }
  };
  r.readAsText(file);
};

// Export CSV (All saved processes, Steps grouped into single column).
// Improved/explicit column names and correct name handling:
// Columns: Saved Key, Process Name, Type, Film/Paper, Developer, Temperature (Â°C), Push/Pull, Total Time, Notes, Steps
function exportCSV() {
  const processEntries = Object.entries(processes);
  if (!processEntries.length) { alert("No saved processes to export."); return; }

  const header = [
    "Saved Key",
    "Process Name",
    "Type",
    "Film/Paper",
    "Developer",
    "Temperature (Â°C)",
    "Push/Pull",
    "Total Time",
    "Notes",
    "Steps"
  ];
  const rows = [header];

  processEntries.forEach(([savedKey, p]) => {
    const proc = p || {};
    const stepsArr = proc.steps || [];
    const totalSec = stepsArr.reduce((s, st) => s + ((st.min || 0) * 60 + (st.sec || 0)), 0);

    // Steps as single string, numbered, separated by " | "
    const stepsText = stepsArr.map((st, idx) => {
      const dur = formatTime((st.min || 0) * 60 + (st.sec || 0));
      const tipPart = st.tip ? ` - ${st.tip}` : "";
      return `${idx + 1}. ${st.name || ""} (${dur})${tipPart}`;
    }).join(" | ");

    const row = [
      savedKey,
      proc.processName || savedKey,
      proc.processType || "",
      proc.filmName || "",
      proc.developerName || "",
      proc.temperature || "",
      proc.pushPull || "",
      formatTime(totalSec),
      (proc.notes || "").replace(/\r?\n/g, " | "),
      stepsText
    ];

    rows.push(row);
  });

  const csvContent = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",")).join("\n");
  const bom = "\uFEFF";
  const blob = new Blob([bom + csvContent], { type: "text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `darkroom-saved-processes-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
}

// Print card (keeps the print option)
function printCard() {
  if (steps.length === 0) { alert("Add steps first"); return; }
  let content = `<!DOCTYPE html><html><head><title>Darkroom Card</title><style>body{font-family:monospace;margin:20px;line-height:1.8}h1{margin:10px 0;border-bottom:2px solid #000;padding-bottom:10px}.info{margin:10px 0;border:1px solid #000;padding:10px}.step{margin:8px 0;padding:8px;border-left:4px solid #000;padding-left:10px}.tip{font-size:0.9em;color:#666;margin-top:4px}</style></head><body>`;
  content += `<h1>${processName.value || "Process"}</h1><div class="info"><strong>Process:</strong> ${processName.value}<br><strong>Film/Paper:</strong> ${filmName.value || "-"}<br><strong>Developer:</strong> ${developerName.value || "-"}<br><strong>Temperature:</strong> ${temperature.value || "-"}Â°C<br><strong>Push/Pull:</strong> ${pushPull.value}</div><h3>Steps:</h3>`;
  steps.forEach((s,i) => {
    const stepTime = formatTime((s.min||0)*60 + (s.sec||0));
    content += `<div class="step"><strong>${i+1}. ${s.name}</strong> - ${stepTime}${s.tip ? `<div class="tip">${s.tip}</div>` : ""}</div>`;
  });
  content += `</body></html>`;
  const win = window.open();
  win.document.write(content);
  win.document.close();
  setTimeout(() => win.print(), 250);
}

// ===== History storage (UI removed) =====
function addToHistory(processName) {
  const now = new Date();
  const dateStr = now.toLocaleDateString();
  const timeStr = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  history.unshift(`${dateStr} ${timeStr} - ${processName}`);
  if (history.length > 200) history.pop();
  localStorage.setItem("darkroomHistory", JSON.stringify(history));
}

// ===== Keyboard & wake lock =====
document.addEventListener("keydown", (e) => {
  if (e.code === "Space") { e.preventDefault(); if (!isRunning) start(); else pause(); }
  if (e.code === "Escape") stopTimer();
});

document.addEventListener("visibilitychange", async () => {
  if (document.hidden && wakelock) { try { await wakelock.release(); } catch (e) { console.warn("WakeLock release failed", e); } wakelock = null; }
  else if (!document.hidden && isRunning) { try { if ("wakeLock" in navigator && !wakelock) wakelock = await navigator.wakeLock.request("screen"); } catch (err) { console.log("Wake lock re-request failed:", err); wakelock = null; } }
});

document.addEventListener("touchmove", (e) => { if (isRunning) e.preventDefault(); }, { passive: false });

// Start
init();
</script>
</body>
</html>
